# Flink用法示例
> 基于Flink 1.14.4实现


## 热门实时商品统计

- 基本需求

  - 统计近一个小时内的热门商品，每五分钟更新一次
  - 统计每分钟的ip访问量，取出访问量最大的5个地址，每5秒更新一次

- 解决思路

  - 在所有用户行为数据中，过滤出浏览（"pv"）行为进行统计
  - 构建滑动窗口，窗口长度为1小时，滑动距离为5分钟

- 阿里天池数据集

  UserBehavior.csv

  下载： https://tianchi.aliyun.com/dataset/dataDetail?dataId=649

- 数据格式说明

  | 文件名称         | 说明                   | 包含特征                                     |
  | :--------------- | :--------------------- | :------------------------------------------- |
  | UserBehavior.csv | 包含所有的用户行为数据 | 用户ID，商品ID，商品类目ID，行为类型，时间戳 |
  
  | 列名称     | 说明                                               |
  | :--------- | :------------------------------------------------- |
  | 用户ID     | 整数类型，序列化后的用户ID                         |
  | 商品ID     | 整数类型，序列化后的商品ID                         |
  | 商品类目ID | 整数类型，序列化后的商品所属类目ID                 |
  | 行为类型   | 字符串，枚举类型，包括('pv', 'buy', 'cart', 'fav') |
  | 时间戳     | 行为发生的时间戳                                   |
  
  用户行为类型共有四种，它们分别是
  
  | 行为类型 | 说明                     |
  | :------- | :----------------------- |
  | pv       | 商品详情页pv，等价于点击 |
  | buy      | 商品购买                 |
  | cart     | 将商品加入购物车         |
  | fav      | 收藏商品                 |
  
  关于数据集大小的一些说明如下
  
  | 维度         | 数量        |
  | :----------- | :---------- |
  | 用户数量     | 987,994     |
  | 商品数量     | 4,162,024   |
  | 用户数量     | 987,994     |
  | 商品类目数量 | 9,439       |
  | 所有行为数量 | 100,150,807 |
  
  
  
  



## 实时流量统计——热门页面

- 基本需求
  - 从web服务器的日志中，统计实时的热门访问页面
  - 统计每分钟的ip访问量，取出访问量最大的5个地址，每5秒更新一次
  
- 解决思路
  - 将apache服务器日志中的时间，转换为时间戳，作为Event Time
  - 构建滑动窗口，窗口长度为1分钟，滑动距离为5秒
  
- 数据格式说明




## 实时流量统计——PV和UV

- 基本需求
  - 从埋点日志中，统计实时的PV和UV
  - 统计每小时的访问量（PV），并且对用户进行去重（UV）
- 解决思路
  - 统计埋点日志中的pv行为，利用Set数据结构进行去重
  - **对于超大规模的数据，可以考虑用布隆过滤器进行去重**
- 数据格式说明
  - 同 热门实时商品统计



## 市场营销分析——APP市场推广统计

- 基本需求
  - 从埋点日志中，统计APP市场推广的数据指标
  - 按照不同的推广渠道，分别统计数据
- 解决思路
  - 通过过滤日志中的用户行为，按照不同的渠道进行统计
  - 可以用process function处理，得到自定义的输出数据信息



## 市场营销分析——页面广告统计

- 基本需求
  - 从埋点日志中，统计每小时页面广告的点击量，5秒刷新一次，并按照不同省份进行划分
  - 对于"刷单"式的频繁点击行为进行过滤，并将该用户加入黑名单
- 解决思路
  - 根据省份进行分组，创建长度为1小时、滑动距离为5秒的时间窗口进行统计
  - 可以用`process function`进行黑名单过滤，检测用户对同一广告的点击量，如果超过上限则将用户信息以侧输出流输出到黑名单中



## 恶意登录监控

- 基本需求
  - 用户在短时间内频繁登录失败，有程序恶意攻击的可能
  - 同一用户（可以是不同IP）在2秒内连续两次登录失败，需要报警
- 解决思路
  - 将用户的登录失败行为存入ListState，设定定时器2秒后出发，查看ListState中有几次失败登录
  - 更加精确的检测，可以使用CEP库实现事件流的模式匹配



## 订单支付实时监控

- 基本需求
  - 用户下单之后，应设置订单失效事件，以提高用户支付的意愿，并降低系统风险
  - 用户下单后15分钟未支付，则输出监控信息
- 解决思路
  - 利用CEP库进行事件流的模式匹配，并设定匹配的时间间隔
  - 也可以利用状态编程，用process function实现处理逻辑



